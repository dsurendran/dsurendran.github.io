---
layout: post
title: Perfect Singleton in Java... is it possible?
date: '2016-01-31T11:13:00.000-08:00'
author: Surendran's blog
tags: 
modified_time: '2016-01-31T11:23:23.526-08:00'
blogger_id: tag:blogger.com,1999:blog-1982846252446038176.post-5808296898584837724
blogger_orig_url: https://surendran-spaces.blogspot.com/2016/01/perfect-singleton-in-java-is-it-possible.html
---

<div dir="ltr" style="text-align: left;" trbidi="on">Singleton is most easily understood and over used (only in talks) pattern. I wanted to write a perfect singleton considering all the scenairos. Came up with following<br /><br /><div><!-- BEGIN --> <!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">import</span> <span style="color: #0e84b5; font-weight: bold;">java.io.*</span><span style="color: #333333;">;</span><br /><br /><span style="color: #008800; font-weight: bold;">public</span> <span style="color: #008800; font-weight: bold;">class</span> <span style="color: #bb0066; font-weight: bold;">Singleton</span> <span style="color: #008800; font-weight: bold;">implements</span> Serializable <span style="color: #333333;">{</span><br /><br />    <span style="color: #008800; font-weight: bold;">private</span> <span style="color: #008800; font-weight: bold;">static</span> Singleton instance <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">null</span><span style="color: #333333;">;</span><br />    <span style="color: #008800; font-weight: bold; line-height: 125%;">private</span><span style="line-height: 125%;">&nbsp;</span><span style="color: #008800; font-weight: bold;">transient </span><span style="line-height: 125%;">Integer someObject = null;</span></pre><pre style="line-height: 125%; margin: 0;">    <span style="color: #008800; font-weight: bold;">private</span> <span style="color: #0066bb; font-weight: bold;">Singleton</span><span style="color: #333333;">()</span> <span style="color: #333333;">{</span><br />        <span style="color: #888888;">//avoid breaking from Reflection</span><br />        <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(</span>instance <span style="color: #333333;">!=</span> <span style="color: #008800; font-weight: bold;">null</span><span style="color: #333333;">)</span><br />            <span style="color: #008800; font-weight: bold;">throw</span> <span style="color: #008800; font-weight: bold;">new</span> <span style="color: #0066bb; font-weight: bold;">RuntimeException</span><span style="color: #333333;">(</span><span style="background-color: #fff0f0;">"Instance already created"</span><span style="color: #333333;">);</span><br />        someObject <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">new</span> Integer<span style="color: #333333;">(</span><span style="color: #0000dd; font-weight: bold;">100</span><span style="color: #333333;">);</span><br /><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #008800; font-weight: bold;">public</span> <span style="color: #008800; font-weight: bold;">static</span> Singleton <span style="color: #0066bb; font-weight: bold;">getInstance</span><span style="color: #333333;">()</span> <span style="color: #333333;">{</span><br />        <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(</span>instance <span style="color: #333333;">==</span> <span style="color: #008800; font-weight: bold;">null</span><span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />            <span style="color: #008800; font-weight: bold;">synchronized</span> <span style="color: #333333;">(</span>Singleton<span style="color: #333333;">.</span><span style="color: #0000cc;">class</span><span style="color: #333333;">)</span> <span style="color: #333333;">{</span><br />                <span style="color: #008800; font-weight: bold;">if</span> <span style="color: #333333;">(</span>instance <span style="color: #333333;">==</span> <span style="color: #008800; font-weight: bold;">null</span><span style="color: #333333;">)</span><br />                    instance <span style="color: #333333;">=</span> <span style="color: #008800; font-weight: bold;">new</span> Singleton<span style="color: #333333;">();</span><br />            <span style="color: #333333;">}</span><br />        <span style="color: #333333;">}</span><br />        <span style="color: #008800; font-weight: bold;">return</span> instance<span style="color: #333333;">;</span><br />    <span style="color: #333333;">}</span><br /><br />    <span style="color: #008800; font-weight: bold;">protected</span> Object <span style="color: #0066bb; font-weight: bold;">readResolve</span><span style="color: #333333;">()</span> <span style="color: #008800; font-weight: bold;">throws</span> ObjectStreamException<span style="color: #333333;">{</span><br />        <span style="color: #888888;">//return the same instance when de-serializing</span><br />        <span style="color: #008800; font-weight: bold;">return</span> <span style="color: #0066bb; font-weight: bold;">getInstance</span><span style="color: #333333;">();</span><br />    <span style="color: #333333;">}</span><br /><span style="color: #333333;">}</span><br /></pre></div><!-- END --></div><div><br />Issue arises if you want to serailize the singleton with some fields, suppose we need to have a<br />private String name;<br />inside the Singleton class.<br /><br />Problem arises while deserializing the class. (readResolve() is broken)... lets see how...<br /><br />readResolve() will be invoked only after the de-seraialization is complete.(i.e, there is a deseralized instance in memory). After the deseraialization we will return the already created instance using getInstance(). Now what will happen to the de-serialized object.... it will be garbage collected.<br /><br />There is a way to get around and get the reference of the temporary instance created and prevent it from getting garbage collected. This can be done by using a stealer class mentioned in effective java (Item 77)<br /><br />This can be resolved by having all the fields in singleton as transient. But whats the use of serializing the singleton with all the fields transient.<br /><br />So whats the prefered and easier way to implement singleton is Enum<br /><br /><!-- HTML generated using hilite.me --> <br /><div style="background: #ffffff; border-width: 0.1em 0.1em 0.1em 0.8em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">public</span> <span style="color: #008800; font-weight: bold;">enum</span> Singleton<span style="color: #333333;">{</span><br />    INSTANCE<span style="color: #333333;">;</span><br />    <span style="color: #008800; font-weight: bold;">public</span> <span style="color: #333399; font-weight: bold;">void</span> <span style="color: #0066bb; font-weight: bold;">operation</span><span style="color: #333333;">(){</span><br />    <span style="color: #333333;">}</span><br /><span style="color: #333333;">}</span><br /></pre></div><br />In case of Enum instance control is guaranteed by JVM,<br /><br />Only disadvantage of having enum Singleton is the class is not extendible the enum Singleton class is by default final class.<br /><br />Usage of singleton I have seen is very very minimal compared to other patterns. Its best if the pattern avoided as far as possible considering the complexity and testability constraints (still can be mocked with powermock) the pattern imposes.<br /><br />finally:&nbsp;Perfect Singleton in Java... is it possible? answer is NO<br /><br /><br /><!---BEGIN---> <!---END---->  </div></div>